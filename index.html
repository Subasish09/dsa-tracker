<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DSA TRACKER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <script>
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });
    </script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #fafafa;
            --card: rgba(255, 255, 255, 0.65);
            --text: #18181b;
            --border: rgba(228, 228, 231, 0.8);
            --primary: #4f46e5;
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
        }

        [data-theme='dark'] {
            --bg: #09090b;
            /* Deep Void */
            --card: rgba(20, 20, 23, 0.6);
            /* Darker Glass */
            --text: #e4e4e7;
            --border: rgba(63, 63, 70, 0.4);
            --primary: #818cf8;
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.4s ease;
            overflow-x: hidden;
            width: 100%;
        }

        /* JetBrains Mono for Code */
        code,
        pre,
        .editor-area,
        .monaco-editor {
            font-family: 'JetBrains Mono', monospace !important;
            font-variant-ligatures: active;
        }

        /* Aurora Background */
        .aurora-bg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            background:
                radial-gradient(at 0% 0%, rgba(79, 70, 229, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(236, 72, 153, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(34, 211, 238, 0.15) 0px, transparent 50%);
            filter: blur(40px);
            opacity: 0.6;
            animation: aurora-shift 20s infinite alternate linear;
        }

        @keyframes aurora-shift {
            0% {
                transform: scale(1);
            }

            100% {
                transform: scale(1.1);
            }
        }

        /* Glassmorphism Utilities */
        .glass {
            background: var(--card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.05);
        }

        /* ... existing css ... */

        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            /* Very transparent for internal panels */
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Animations */
        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        @keyframes pulse-soft {

            0%,
            100% {
                opacity: 0.8;
            }

            50% {
                opacity: 0.5;
            }
        }

        @keyframes slide-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-float {
            animation: float 6s ease-in-out infinite;
        }

        .animate-slide-up {
            animation: slide-up 0.5s ease-out forwards;
        }

        /* Background Blobs */
        .blob {
            position: fixed;
            border-radius: 50%;
            filter: blur(100px);
            z-index: -1;
            opacity: 0.08;
            /* Much more subtle */
            animation: pulse-soft 10s infinite alternate;
        }

        .blob-1 {
            top: -10%;
            left: -10%;
            width: 600px;
            height: 600px;
            background: #4f46e5;
        }

        .dark .blob-1 {
            opacity: 0.15;
            background: #4338ca;
        }

        .blob-2 {
            bottom: -10%;
            right: -10%;
            width: 700px;
            height: 700px;
            background: #8b5cf6;
            /* Violet */
            animation-delay: 2s;
        }

        .dark .blob-2 {
            opacity: 0.15;
            background: #7c3aed;
        }

        .blob-3 {
            top: 40%;
            left: 40%;
            width: 400px;
            height: 400px;
            background: #e4e4e7;
            /* Zinc 200 */
            opacity: 0.1;
            animation-delay: 4s;
        }

        .dark .blob-3 {
            background: #27272a;
            /* Zinc 800 */
            opacity: 0.2;
        }



        .stat-card {
            background: var(--card);
            /* Fallback */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: var(--glass-border);
            border-radius: 24px;
            padding: 24px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-height: 280px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-subtle);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: rgba(79, 70, 229, 0.5);
            /* Primary highlight */
            box-shadow: var(--shadow-glow);
            z-index: 10;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            margin-top: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            background: var(--border);
        }

        .calendar-day-header {
            background: var(--card);
            font-size: 10px;
            font-weight: 800;
            text-align: center;
            padding: 4px 0;
            opacity: 0.5;
        }

        .calendar-day {
            background: var(--card);
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
        }

        .day-active {
            background: var(--primary) !important;
            color: white !important;
            font-weight: 800;
            cursor: pointer;
            transition: 0.2s;
        }

        /* --- Professional Markdown Typography --- */
        .markdown-body {
            font-size: 1rem;
            line-height: 1.75;
            color: var(--text);
            word-wrap: break-word;
        }

        .markdown-body>*:first-child {
            margin-top: 0 !important;
        }

        .markdown-body>*:last-child {
            margin-bottom: 0 !important;
        }

        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3,
        .markdown-body h4,
        .markdown-body h5,
        .markdown-body h6 {
            color: var(--text);
            font-weight: 800;
            line-height: 1.3;
            margin-top: 1.5em;
            margin-bottom: 0.8em;
        }

        .dark .markdown-body,
        .dark .markdown-body>*:not(code):not(pre) {
            color: #f1f5f9 !important;
        }

        .dark .markdown-body h1,
        .dark .markdown-body h2 {
            color: #60a5fa !important;
        }

        .dark .markdown-body code {
            color: #e2e8f0;
            background-color: rgba(30, 41, 59, 0.5);
        }



        .markdown-body h1 {
            font-size: 2.25em;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.3em;
            color: var(--primary);
        }

        .markdown-body h2 {
            font-size: 1.75em;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.3em;
            color: var(--primary);
        }

        .markdown-body h3 {
            font-size: 1.5em;
        }

        .markdown-body h4 {
            font-size: 1.25em;
        }

        .markdown-body p {
            margin-bottom: 1.25em;
            margin-top: 0;
        }

        .markdown-body a {
            color: var(--primary);
            text-decoration: underline;
            font-weight: 600;
        }

        .markdown-body a:hover {
            text-decoration: none;
        }

        .markdown-body ul,
        .markdown-body ol {
            margin-top: 0;
            margin-bottom: 1.25em;
            padding-left: 1.625em;
        }

        .markdown-body ul {
            list-style-type: disc;
        }

        .markdown-body ol {
            list-style-type: decimal;
        }

        .markdown-body li {
            margin-bottom: 0.375em;
        }

        .markdown-body li>p {
            margin-top: 0.75em;
            margin-bottom: 0.75em;
        }

        .markdown-body li>ul,
        .markdown-body li>ol {
            margin-top: 0.75em;
            margin-bottom: 0.75em;
        }

        .markdown-body blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 1em;
            color: inherit;
            opacity: 0.8;
            font-style: italic;
            margin-bottom: 1.5em;
            background: rgba(59, 130, 246, 0.1);
            padding: 1rem;
            border-radius: 0 8px 8px 0;
        }

        .markdown-body hr {
            height: 0.2em;
            width: 100%;
            padding: 0;
            margin: 24px 0;
            background-color: var(--border);
            border: 0;
        }

        .markdown-body code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.875em;
            background-color: rgba(125, 125, 125, 0.2);
            padding: 0.2em 0.4em;
            border-radius: 6px;
        }

        .markdown-body pre {
            background-color: #1e1e1e;
            padding: 1em;
            overflow: auto;
            border-radius: 12px;
            margin-bottom: 1.5em;
            border: 1px solid var(--border);
        }

        .markdown-body pre code {
            background-color: transparent;
            padding: 0;
            color: #d4d4d4;
            font-size: 0.9em;
        }

        .markdown-body table {
            display: block;
            width: 100%;
            overflow: auto;
            margin-bottom: 1.5em;
            border-spacing: 0;
            border-collapse: collapse;
        }

        .markdown-body table tr {
            background-color: transparent;
            border-top: 1px solid var(--border);
        }

        .markdown-body table tr:nth-child(2n) {
            background-color: rgba(125, 125, 125, 0.05);
        }

        .markdown-body table th,
        .markdown-body table td {
            padding: 6px 13px;
            border: 1px solid var(--border);
        }

        .markdown-body table th {
            font-weight: 600;
        }

        .markdown-body img {
            max-width: 100%;
            box-sizing: content-box;
            background-color: transparent;
            border-radius: 8px;
            margin-bottom: 1.5em;
        }

        .workspace-container {
            display: flex;
            flex-direction: column;
            min-height: 500px;
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            background: var(--card);
        }

        @media (min-width: 1024px) {
            .workspace-container {
                flex-direction: row;
                height: 550px;
            }
        }

        .editor-area {
            flex: 1;
            width: 100%;
            padding: 16px;
            border: none;
            outline: none;
            background: transparent;
            font-family: 'Consolas', monospace;
            font-size: 16px;
            line-height: 1.7;
            resize: none;
            color: var(--ink);
        }

        .toolbar-btn {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 800;
            background: var(--bg);
            border: 1px solid var(--border);
            cursor: pointer;
        }

        .search-input {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px 20px;
            width: 100%;
            outline: none;
            transition: 0.3s;
            font-weight: 600;
        }

        .filter-chip {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
            cursor: pointer;
            transition: 0.3s;
            border: 1px solid var(--border);
            text-transform: uppercase;
        }

        .chip-easy.active {
            background: #22c55e !important;
            color: white !important;
        }

        .chip-medium.active {
            background: #f97316 !important;
            color: white !important;
        }

        .chip-hard.active {
            background: #ef4444 !important;
            color: white !important;
        }

        /* Markdown Spacing Fix */
        .markdown-body {
            line-height: 1.5 !important;
        }

        .markdown-body p {
            margin-bottom: 0.75em !important;
        }

        .markdown-body ul,
        .markdown-body ol {
            margin-bottom: 0.75em !important;
        }

        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3,
        .markdown-body h4 {
            margin-top: 1em !important;
            margin-bottom: 0.5em !important;
            line-height: 1.3 !important;
        }

        @media (max-width: 768px) {
            html {
                font-size: 14px;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Component } = React;

        // Error Boundary Class
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex flex-col items-center justify-center p-8 text-center bg-slate-50 dark:bg-slate-950">
                            <h1 className="text-4xl font-black mb-4">Something went wrong.</h1>
                            <p className="opacity-60 mb-8">This usually happens if your GitHub data.json has a syntax error.</p>
                            <button onClick={() => window.location.reload()} className="bg-blue-600 text-white px-8 py-3 rounded-2xl font-bold">Refresh Page</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const USER = "Subasish09";
        const REPO = "dsa-tracker";
        const RAW_URL = `https://raw.githubusercontent.com/${USER}/${REPO}/main/data.json`;
        const API_URL = `https://api.github.com/repos/${USER}/${REPO}/contents/data.json`;

        // --- Components ---

        const Editor = ({ language, value, theme, onChange }) => {
            const divEl = useRef(null);
            const editor = useRef(null);
            useEffect(() => {
                if (divEl.current) {
                    // Initialize Monaco
                    window.require(['vs/editor/editor.main'], () => {
                        if (!editor.current) {
                            editor.current = window.monaco.editor.create(divEl.current, {
                                value: value,
                                language: language,
                                theme: theme === 'dark' ? 'vs-dark' : 'vs',
                                automaticLayout: true,
                                minimap: { enabled: false },
                                fontSize: 14,
                                fontFamily: "'Consolas', 'Monaco', monospace",
                                scrollBeyondLastLine: false,
                                padding: { top: 16, bottom: 16 }
                            });
                            editor.current.onDidChangeModelContent(() => {
                                onChange(editor.current.getValue());
                            });
                        }
                    });
                }
                return () => { if (editor.current) editor.current.dispose(); };
            }, []); // Init once

            // Update Theme
            useEffect(() => {
                if (window.monaco && editor.current) window.monaco.editor.setTheme(theme === 'dark' ? 'vs-dark' : 'vs');
            }, [theme]);

            // Update Language
            useEffect(() => {
                if (window.monaco && editor.current) {
                    const model = editor.current.getModel();
                    window.monaco.editor.setModelLanguage(model, language);
                }
            }, [language]);

            return <div ref={divEl} className="w-full h-full" />;
        };

        const NavBar = ({ view, setView, theme, setTheme, lastSync, onNewLog }) => (
            <nav className="sticky top-4 mx-4 md:mx-8 z-50 rounded-2xl glass px-4 py-3 md:px-6 md:py-4 flex flex-col md:flex-row items-center justify-between gap-4 transition-all duration-300 text-slate-900 dark:text-white mb-8 shadow-lg">
                <div className="flex items-center gap-4 w-full md:w-auto justify-between md:justify-start">
                    <div className="flex items-center gap-3">
                        <div className="w-12 h-12 bg-gradient-to-tr from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center font-black text-white shadow-lg shadow-indigo-500/30 text-xl tracking-tighter animate-float">C2</div>
                        <div>
                            <h1 className="text-xl font-extrabold tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400">DSA TRACKER</h1>
                            <p className="text-[9px] font-bold opacity-60 dark:opacity-70 uppercase tracking-widest">Last Sync: {lastSync}</p>
                        </div>
                    </div>
                </div>
                <div className="flex items-center gap-2 bg-slate-100/50 dark:bg-slate-900/50 p-1.5 rounded-xl border border-slate-200/50 dark:border-slate-800/50 backdrop-blur-sm">
                    {['dashboard', 'practice', 'theory', 'practice_logs'].map(v => (
                        <button
                            key={v}
                            onClick={() => setView(v)}
                            className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${view === v || (v === 'theory' && view === 'theory_edit') ? 'bg-white dark:bg-slate-800 text-indigo-600 dark:text-indigo-400 shadow-sm scale-105' : 'opacity-60 hover:opacity-100'}`}
                        >
                            {v === 'dashboard' ? 'Home' : v === 'practice' ? 'IDE' : v === 'theory' ? 'Notes' : 'History'}
                        </button>
                    ))}
                </div>
                <div className="flex items-center gap-2">
                    <button onClick={() => {
                        const blob = new Blob([localStorage.getItem('dsa-tracker-data') || JSON.stringify({ logs: [], history: [], practice: [], theory: [] })], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `dsa-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
                        a.click();
                    }} className="flex items-center gap-2 px-3 py-2 opacity-60 hover:opacity-100 transition-all border border-slate-300 dark:border-slate-700 rounded-xl font-bold text-xs hover:bg-slate-100 dark:hover:bg-slate-800" title="Export Data">
                        <span className="text-sm">üíæ</span> <span className="hidden md:inline">Export</span>
                    </button>
                    <button onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')} className="p-2 opacity-80 hover:opacity-100 transition-opacity bg-slate-100 dark:bg-slate-800 rounded-xl">{theme === 'light' ? 'üåô' : '‚òÄÔ∏è'}</button>
                    {view === 'dashboard' && <button onClick={onNewLog} className="bg-gradient-to-r from-indigo-600 to-blue-600 text-white px-5 py-2.5 rounded-xl font-bold text-xs shadow-lg shadow-indigo-500/30 transform hover:scale-105 transition-all outline-none ring-2 ring-offset-2 ring-indigo-500 ring-offset-transparent">+ Log</button>}
                </div>
            </nav>
        );

        const StatCard = ({ children, className = "", style = {} }) => (
            <div className={`stat-card ${className}`} style={style}>
                {children}
            </div>
        );

        const Calendar = ({ calendarData, setSearchTerm, onPrev, onNext }) => (
            <div className="stat-card border-l-4 border-l-orange-500">
                <div className="flex justify-between items-center mb-1 dark:text-white">
                    <span className="text-[10px] font-black opacity-40 uppercase">Persistence</span>
                    <div className="flex items-center gap-2">
                        <button onClick={onPrev} className="hover:bg-slate-100 dark:hover:bg-slate-800 p-1 rounded transition-colors text-xs">‚óÄ</button>
                        <span className="text-[10px] font-bold text-orange-500 min-w-[60px] text-center">{calendarData.monthName}</span>
                        <button onClick={onNext} className="hover:bg-slate-100 dark:hover:bg-slate-800 p-1 rounded transition-colors text-xs">‚ñ∂</button>
                    </div>
                </div>
                <div className="calendar-grid">
                    {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map(d => <div key={d} className="calendar-day-header">{d}</div>)}
                    {calendarData.days.map((d, i) => <div key={i} onClick={() => d.active && setSearchTerm(d.raw)} className={`calendar-day ${d.active ? 'day-active' : ''}`}>{d.day}</div>)}
                </div>
            </div>
        );

        const ContributionHeatmap = ({ data }) => {
            const weeks = useMemo(() => {
                const today = new Date();
                const yearAgo = new Date();
                yearAgo.setDate(today.getDate() - 364);

                const activityMap = new Map();
                [...data.logs, ...data.practice, ...data.theory].forEach(item => {
                    // Normalize date to YYYY-MM-DD
                    const d = item.date.split('/').reverse().join('-'); // Handle DD/MM/YYYY if present
                    const dateStr = item.date.includes('-') ? item.date : d;
                    activityMap.set(dateStr, (activityMap.get(dateStr) || 0) + 1);
                });

                const weeksArr = [];
                let currentWeek = [];

                // Align start date to Sunday for proper grid
                const startDate = new Date(yearAgo);
                while (startDate.getDay() !== 0) startDate.setDate(startDate.getDate() - 1);

                for (let i = 0; i < 371; i++) { // Slightly more than 52 weeks to fill grid
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);

                    if (date > today && date.getDay() === 0) break; // Stop future weeks

                    // Fix: Use Local Time YYYY-MM-DD instead of toISOString (UTC)
                    // This matches the normalized Log dates which are based on local input
                    const y = date.getFullYear();
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const d = String(date.getDate()).padStart(2, '0');
                    const dateStr = `${y}-${m}-${d}`;

                    const count = activityMap.get(dateStr) || 0;

                    // Color Logic
                    let color = "bg-slate-100 dark:bg-slate-800";
                    if (count > 0) color = "bg-teal-200 dark:bg-teal-900";
                    if (count > 2) color = "bg-teal-400 dark:bg-teal-700";
                    if (count > 4) color = "bg-teal-500 dark:bg-teal-500";
                    if (count > 6) color = "bg-teal-600 dark:bg-teal-400";

                    currentWeek.push({ date: dateStr, count, color });

                    if (currentWeek.length === 7) {
                        weeksArr.push(currentWeek);
                        currentWeek = [];
                    }
                }
                return weeksArr;
            }, [data]);

            return (
                <div className="stat-card !min-h-0 overflow-x-auto bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-800">
                    <div className="flex justify-between items-center mb-4 sticky left-0">
                        <h3 className="text-xs font-black uppercase tracking-widest opacity-50 dark:text-white">Yearly Activity</h3>
                        <div className="flex items-center gap-1 text-[10px] opacity-50 font-bold dark:text-white">
                            <span>Less</span>
                            <div className="w-2 h-2 rounded bg-slate-100 dark:bg-slate-800"></div>
                            <div className="w-2 h-2 rounded bg-teal-200 dark:bg-teal-900"></div>
                            <div className="w-2 h-2 rounded bg-teal-400 dark:bg-teal-700"></div>
                            <div className="w-2 h-2 rounded bg-teal-600 dark:bg-teal-400"></div>
                            <span>More</span>
                        </div>
                    </div>
                    <div className="flex gap-1 min-w-max justify-center">
                        {weeks.map((week, i) => (
                            <div key={i} className="flex flex-col gap-1">
                                {week.map((day, j) => (
                                    <div
                                        key={day.date}
                                        className={`w-3 h-3 rounded-sm ${day.color} transition-all hover:scale-150 hover:z-10 cursor-pointer border border-transparent hover:border-white/20`}
                                        title={`${day.date}: ${day.count} contributions`}
                                    ></div>
                                ))}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Dynamic Color Generation (Pastel)
        const stringToColor = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            const h = Math.abs(hash) % 360;
            return `hsl(${h}, 70%, 85%)`; // Light pastel for BG
        };
        const stringToColorDark = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            const h = Math.abs(hash) % 360;
            return `hsl(${h}, 70%, 25%)`; // Darker pastel for Dark Mode BG
        };
        const stringToColorText = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            const h = Math.abs(hash) % 360;
            return `hsl(${h}, 80%, 30%)`; // Dark text for Light Mode
        };
        const stringToColorTextDark = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            const h = Math.abs(hash) % 360;
            return `hsl(${h}, 80%, 80%)`; // Light text for Dark Mode
        };

        const LogEntry = ({ log, diffColors, expanded, onToggle, onDelete, onEdit, onDownload }) => (
            <div className="stat-card !min-h-0 cursor-pointer p-6 dark:text-white" onClick={onToggle}>
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 md:gap-0">
                    <div className="flex items-center gap-3 w-full md:w-auto mb-2 md:mb-0">
                        <div className="diff-dot" style={{ backgroundColor: diffColors[log.difficulty || 'Medium'], width: 12, height: 12, borderRadius: '50%', boxShadow: `0 0 8px ${diffColors[log.difficulty || 'Medium']}`, flexShrink: 0 }}></div>
                        <span className="font-bold text-lg md:text-base leading-tight">{log.title}</span>
                    </div>
                    <div className="flex flex-wrap items-center gap-2 md:gap-4 w-full md:w-auto">
                        {log.type === 'practice' && <span className="bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 text-[10px] px-2 py-0.5 rounded-full font-bold border border-purple-200 dark:border-purple-800">IDE</span>}
                        {log.subtopic && log.subtopic.split('+').map(s => s.trim()).filter(Boolean).map(sub => (
                            <span key={sub} className="text-[10px] font-bold px-2 py-0.5 rounded-md border border-black/5 dark:border-white/10" style={{
                                backgroundColor: window.matchMedia('(prefers-color-scheme: dark)').matches ? stringToColorDark(sub) : stringToColor(sub),
                                color: window.matchMedia('(prefers-color-scheme: dark)').matches ? stringToColorTextDark(sub) : stringToColorText(sub)
                            }}>{sub}</span>
                        ))}
                        <span className={`text-[10px] ${log.date === 'Invalid Date' ? 'text-red-500 font-black animate-pulse' : 'opacity-40'} ml-auto md:ml-0`}>{log.date}</span>
                    </div>
                </div>
                {expanded && (
                    <div className="mt-4 p-4 bg-slate-50 dark:bg-slate-900 rounded-xl space-y-4 cursor-default" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-end gap-2 border-b border-slate-200 dark:border-slate-800 pb-2 mb-2">
                            <button onClick={() => onEdit(log)} className="p-2 hover:bg-slate-200 dark:hover:bg-slate-800 rounded-lg text-xs font-bold flex items-center gap-1">‚úèÔ∏è Edit</button>
                            <button onClick={() => onDownload(log)} className="p-2 hover:bg-slate-200 dark:hover:bg-slate-800 rounded-lg text-xs font-bold flex items-center gap-1">‚¨áÔ∏è PDF</button>
                            <button onClick={() => onDelete(log.id)} className="p-2 hover:bg-red-100 dark:hover:bg-red-900/20 text-red-500 rounded-lg text-xs font-bold flex items-center gap-1">üóë Delete</button>
                        </div>
                        {log.logic ? (
                            <div className="markdown-body" dangerouslySetInnerHTML={{ __html: marked.parse(log.logic) }}></div>
                        ) : (
                            <div className="text-xs opacity-50 italic">No notes recorded for this session.</div>
                        )}
                        {log.code && (
                            <div className="relative group/code">
                                <button
                                    onClick={() => { navigator.clipboard.writeText(log.code); alert('Code copied!'); }}
                                    className="absolute top-2 right-2 bg-white/10 hover:bg-white/20 text-white p-1.5 rounded-lg opacity-0 group-hover/code:opacity-100 transition-opacity text-[10px] font-bold z-10"
                                >
                                    COPY
                                </button>
                                <pre className="p-4 bg-[#0d1117] rounded-xl text-xs text-white overflow-x-auto"><code>{log.code}</code></pre>
                            </div>
                        )}
                        {log.timer && <div className="text-[10px] font-mono opacity-50 text-right">Time Taken: {Math.floor(log.timer / 60)}m {log.timer % 60}s</div>}
                    </div>
                )}
            </div>
        );

        const Toast = ({ message, visible, type }) => {
            if (!visible) return null;
            const colors = {
                warning: "border-orange-500 text-orange-600 bg-orange-50 dark:text-orange-400 dark:bg-orange-900/20",
                success: "border-green-500 text-green-600 bg-green-50 dark:text-green-400 dark:bg-green-900/20",
                error: "border-red-500 text-red-600 bg-red-50 dark:text-red-400 dark:bg-red-900/20"
            };
            return (
                <div className={`fixed top-6 left-1/2 transform -translate-x-1/2 z-[100] px-6 py-3 rounded-xl border ${colors[type] || colors.warning} shadow-2xl backdrop-blur-md animate-slide-up flex items-center gap-3 font-bold`}>
                    <span>{type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è'}</span>
                    <span>{message}</span>
                </div>
            );
        };

        // --- Main App ---

        function App() {
            const [data, setData] = useState({ logs: [], history: [], practice: [], theory: [] });
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState("dashboard");
            const [theme, setTheme] = useState(localStorage.getItem('theme') || 'dark');
            const [token, setToken] = useState(localStorage.getItem('gh_token') || "");
            const [viewDate, setViewDate] = useState(new Date());
            const [lastSync, setLastSync] = useState("Syncing...");
            const [searchTerm, setSearchTerm] = useState("");
            const [diffFilter, setDiffFilter] = useState({ Easy: true, Medium: true, Hard: true });
            const [expandedQuestion, setExpandedQuestion] = useState(null);

            // New State for Theory Search
            const [theorySearchTerm, setTheorySearchTerm] = useState("");

            // New State for Enhancements
            const [sortBy, setSortBy] = useState("Newest");
            const [page, setPage] = useState(1);
            const ITEMS_PER_PAGE = 10;

            const [practiceEntry, setPracticeEntry] = useState({ title: "", topic: "", subtopic: "", code: "", language: "cpp", difficulty: "Medium" });
            const [expandedPracticeId, setExpandedPracticeId] = useState(null);

            const [theoryEntry, setTheoryEntry] = useState({ id: null, title: "", topic: "", date: new Date().toISOString().split('T')[0], content: "" });
            const [output, setOutput] = useState("");
            const [isCompiling, setIsCompiling] = useState(false);
            const [timer, setTimer] = useState(0);
            const [isTimerRunning, setIsTimerRunning] = useState(false);
            const timerRef = useRef(null);

            const [entry, setEntry] = useState({ title: "", logic: "", code: "", difficulty: "Medium", topic: "", subtopic: "", date: new Date().toISOString().split('T')[0] });

            // Dashboard Group By State
            const [groupBy, setGroupBy] = useState("topic"); // 'topic' or 'subtopic'

            // Toast State
            const [toast, setToast] = useState({ message: "", visible: false, type: "warning" });
            const showToast = (message, type = "warning") => {
                setToast({ message, visible: true, type });
                setTimeout(() => setToast(t => ({ ...t, visible: false })), 3000);
            };

            const formatTime = (s) => `${Math.floor(s / 60)}:${String(s % 60).padStart(2, '0')}`;
            const diffColors = { Easy: "#22c55e", Medium: "#f97316", Hard: "#ef4444" };
            const sanitizeTopic = (t) => t ? t.replace(/\s*-\s*/, " - ").trim() : "General";

            // Helper to parse DD/MM/YYYY
            const parseDate = (str) => {
                if (!str || str === "Invalid Date") return new Date(0);
                const parts = str.split('/');
                if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]);
                return new Date(str); // Fallback
            };

            // Reset page when filters change
            useEffect(() => { setPage(1); }, [searchTerm, diffFilter, sortBy]);

            useEffect(() => {
                document.documentElement.setAttribute('data-theme', theme);
                if (theme === 'dark') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', theme);
            }, [theme]);

            useEffect(() => {
                fetch(RAW_URL + "?v=" + Date.now())
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to fetch");
                        return res.json();
                    })
                    .then(resData => {
                        setData({ logs: resData.logs || [], history: resData.history || [], practice: resData.practice || [], theory: resData.theory || [] });
                        setLastSync(new Date().toLocaleString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }));
                        setLoading(false);
                    }).catch(() => {
                        setData({ logs: [], history: [], practice: [], theory: [] });
                        setLastSync("Offline / Error");
                        setLoading(false);
                    });
            }, []);

            useEffect(() => {
                if (isTimerRunning) timerRef.current = setInterval(() => setTimer(p => p + 1), 1000);
                else clearInterval(timerRef.current);
                return () => clearInterval(timerRef.current);
            }, [isTimerRunning]);

            useEffect(() => { if (typeof Prism !== 'undefined') Prism.highlightAll(); }, [view, practiceEntry.code, expandedQuestion, entry.code]);

            const calendarData = useMemo(() => {
                const year = viewDate.getFullYear(), month = viewDate.getMonth();
                const firstDay = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate();
                const days = [];

                // Helper to normalize YYYY-MM-DD to DD/MM/YYYY (en-GB)
                const toGB = (d) => {
                    if (!d) return null;
                    if (d.includes('-')) {
                        const [y, m, day] = d.split('-');
                        return `${day}/${m}/${y}`;
                    }
                    return d;
                };

                const allDates = [
                    ...data.history,
                    ...data.logs.map(l => l.date),
                    ...data.practice.map(p => p.date),
                    ...data.theory.map(t => toGB(t.date))
                ].filter(Boolean);

                const activeDates = new Set(allDates);

                for (let i = 0; i < firstDay; i++) days.push({ day: null });
                for (let i = 1; i <= daysInMonth; i++) {
                    const raw = new Date(year, month, i).toLocaleDateString('en-GB');
                    days.push({ day: i, active: activeDates.has(raw), raw });
                }
                return { days, monthName: viewDate.toLocaleString('default', { month: 'short', year: '2-digit' }) };
            }, [data, viewDate]);

            // Compute Difficulty Counts
            const diffCounts = useMemo(() => {
                const counts = { Easy: 0, Medium: 0, Hard: 0 };
                data.logs.forEach(l => { counts[l.difficulty || 'Medium']++ });
                // Practice sessions now use their own difficulty
                data.practice.forEach(p => { counts[p.difficulty || 'Medium']++ });
                return counts;
            }, [data]);

            const filteredLogs = useMemo(() => {
                const term = searchTerm.toLowerCase();

                const logs = data.logs.map(l => ({ ...l, type: 'log' }));
                const practice = data.practice.map(p => ({
                    ...p,
                    type: 'practice',
                    difficulty: p.difficulty || 'Medium',
                    topic: p.topic || 'Practice Session'
                }));
                const allItems = [...logs, ...practice];

                const filtered = allItems.filter(log => {
                    const matchesSearch =
                        log.title.toLowerCase().includes(term) ||
                        log.date.includes(term) ||
                        sanitizeTopic(log.topic).toLowerCase().includes(term) ||
                        (log.code || "").toLowerCase().includes(term) ||
                        (log.subtopic || "").toLowerCase().includes(term);
                    const matchesDiff = diffFilter[log.difficulty || "Medium"];
                    return matchesSearch && matchesDiff;
                });

                return filtered.sort((a, b) => {
                    if (sortBy === "Newest") return parseDate(b.date) - parseDate(a.date);
                    if (sortBy === "Oldest") return parseDate(a.date) - parseDate(b.date);
                    if (sortBy === "Difficulty") {
                        const weights = { Easy: 1, Medium: 2, Hard: 3 };
                        return weights[a.difficulty || 'Medium'] - weights[b.difficulty || 'Medium'];
                    }
                    if (sortBy === "Topic") return (a.topic || "").localeCompare(b.topic || "");
                    return 0;
                });
            }, [data.logs, data.practice, searchTerm, diffFilter, sortBy]);

            const logsToDisplay = useMemo(() => {
                return filteredLogs.slice(0, page * ITEMS_PER_PAGE);
            }, [filteredLogs, page]);

            const groupedLogs = useMemo(() => {
                return logsToDisplay.reduce((acc, log) => {
                    const t = sanitizeTopic(log.topic);
                    if (!acc[t]) acc[t] = [];
                    acc[t].push(log);
                    return acc;
                }, {});
            }, [logsToDisplay]);

            // Chart Logic: Use ALL data, not filtered data
            const topicStats = useMemo(() => {
                const stats = {};
                // Combine logs and practice for the chart
                const allItems = [...data.logs, ...data.practice];
                allItems.forEach(l => {
                    if (groupBy === 'topic') {
                        const key = sanitizeTopic(l.topic);
                        stats[key] = (stats[key] || 0) + 1;
                    } else {
                        // For subtopic, split by '+'
                        if (l.subtopic) {
                            const parts = l.subtopic.split('+').map(s => s.trim()).filter(Boolean);
                            if (parts.length > 0) {
                                parts.forEach(part => {
                                    stats[part] = (stats[part] || 0) + 1;
                                });
                            } else {
                                stats["Unspecified"] = (stats["Unspecified"] || 0) + 1;
                            }
                        } else {
                            stats["Unspecified"] = (stats["Unspecified"] || 0) + 1;
                        }
                    }
                });

                // Fix: Calculate total from the stats themselves (sum of all counts)
                // This handles cases where one log has multiple subtopics (so count > items)
                // or no subtopics (so count < items).
                const total = Object.values(stats).reduce((acc, curr) => acc + curr, 0);

                if (total === 0) return [];
                return Object.entries(stats)
                    .sort((a, b) => b[1] - a[1])
                    .map(([name, count]) => ({ name, count, percent: (count / total) * 100 }));
            }, [data.logs, data.practice, groupBy]);

            // Note Topics Configuration
            const noteTopics = useMemo(() => {
                const stats = {};
                data.theory.forEach(t => {
                    const topic = t.topic ? t.topic.trim() : "General";
                    stats[topic] = (stats[topic] || 0) + 1;
                });
                return Object.entries(stats)
                    .sort((a, b) => b[1] - a[1]) // Sort by count desc
                    .map(([name, count]) => ({ name, count }));
            }, [data.theory]);

            const handleAction = async (updatedData, msg) => {
                if (!token) { showToast("Please enter GitHub Token first!", "error"); return; }
                try {
                    const res = await fetch(API_URL, { headers: { Authorization: `token ${token}` } });
                    const file = await res.json();
                    await fetch(API_URL, { method: "PUT", headers: { Authorization: `token ${token}`, "Content-Type": "application/json" }, body: JSON.stringify({ message: msg, content: btoa(unescape(encodeURIComponent(JSON.stringify(updatedData, null, 2)))), sha: file.sha }) });
                    setData(updatedData); confetti({ particleCount: 150 }); setView("dashboard"); showToast("Saved successfully!", "success");
                } catch (e) { showToast("Action failed. Check Token/Network.", "error"); }
            };

            const runCode = async () => {
                setIsCompiling(true);
                setOutput("Compiling & Running...");
                try {
                    const res = await fetch("https://emkc.org/api/v2/piston/execute", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            language: practiceEntry.language,
                            version: "*",
                            files: [{ content: practiceEntry.code }]
                        })
                    });
                    const data = await res.json();
                    if (data.run) {
                        setOutput(data.run.output);
                    } else {
                        setOutput("Error: Failed to execute code.");
                    }
                } catch (e) {
                    setOutput("Error: " + e.message);
                } finally {
                    setIsCompiling(false);
                }
            };

            const handleDelete = async (id, type) => {
                if (!token) { return showToast("Please enter GitHub Token first!", "error"); }
                if (!confirm("Are you sure? This cannot be undone.")) return;

                const updatedData = { ...data };
                if (type === 'practice') {
                    updatedData.practice = data.practice.filter(p => p.id !== id);
                } else if (type === 'theory') {
                    updatedData.theory = data.theory.filter(t => t.id !== id);
                } else {
                    updatedData.logs = data.logs.filter(l => l.id !== id);
                }

                await handleAction(updatedData, `Deleted ${type === 'practice' ? 'Practice' : type === 'theory' ? 'Theory' : 'Log'} Item`);
            };

            const downloadPDF = (item) => {
                // Create a container that is visible to html2canvas but hidden from user
                const container = document.createElement('div');
                container.style.position = 'fixed';
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                container.style.zIndex = '-9999';
                container.style.overflow = 'hidden';
                container.style.overflowY = 'auto'; // Allow internal scrolling if needed for rendering
                container.style.opacity = '0'; // Hide from user
                container.style.pointerEvents = 'none';

                // The actual content element
                const element = document.createElement('div');
                element.className = 'markdown-body bg-white text-black';
                element.style.width = '800px';
                element.style.padding = '40px';
                element.style.margin = '0 auto';
                element.style.minHeight = '1123px'; // A4 height

                element.innerHTML = `
                    <div style="font-family: 'Plus Jakarta Sans', sans-serif;">
                        <h1 style="border-bottom: 2px solid #2563eb; padding-bottom: 10px; color: #2563eb; font-size: 24px; font-weight: 800; margin-bottom: 10px;">${item.title || "Untitled"}</h1>
                        <div style="margin-bottom: 30px; color: #666; font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">
                            ${item.topic || "General"} ‚Ä¢ ${item.date || new Date().toLocaleDateString()}
                        </div>
                        <div style="font-size: 14px; line-height: 1.6;">
                            ${marked.parse(item.content || item.logic || "")}
                        </div>
                        ${item.code ? `
                            <div style="margin-top: 30px; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                                <div style="background: #f8fafc; padding: 8px 16px; border-bottom: 1px solid #e2e8f0; font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase;">Code</div>
                                <pre style="background: #1e293b; color: #f1f5f9; padding: 16px; margin: 0; font-family: monospace; font-size: 12px; white-space: pre-wrap;"><code>${item.code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>
                            </div>
                        ` : ''}
                    </div>
                `;

                container.appendChild(element);
                document.body.appendChild(container);

                const opt = {
                    margin: 0,
                    filename: `${(item.title || 'document').replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                // Small delay to ensure rendering happens
                setTimeout(() => {
                    html2pdf().set(opt).from(element).save().then(() => {
                        document.body.removeChild(container);
                    });
                }, 100);
            };

            // Enhanced Loading State (Skeleton)
            if (loading) return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-950 p-8 space-y-8">
                    <div className="h-16 bg-slate-200 dark:bg-slate-900 rounded-xl w-full animate-pulse"></div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {[1, 2, 3].map(i => <div key={i} className="h-64 bg-slate-200 dark:bg-slate-900 rounded-2xl animate-pulse"></div>)}
                    </div>
                    <div className="h-12 bg-slate-200 dark:bg-slate-900 rounded-xl w-full animate-pulse"></div>
                    <div className="space-y-4">
                        {[1, 2, 3, 4].map(i => <div key={i} className="h-32 bg-slate-200 dark:bg-slate-900 rounded-2xl animate-pulse"></div>)}
                    </div>
                </div>
            );

            // Time-based Greeting
            const hour = new Date().getHours();
            const greeting = hour < 12 ? "Good Morning" : hour < 18 ? "Good Afternoon" : "Good Evening";

            // Progress Ring Component
            const ProgressRing = ({ radius, stroke, progress, color }) => {
                const normalizedRadius = radius - stroke * 2;
                const circumference = normalizedRadius * 2 * Math.PI;
                const strokeDashoffset = circumference - (progress / 100) * circumference;

                return (
                    <div className="relative flex items-center justify-center">
                        <svg height={radius * 2} width={radius * 2} className="rotate-[-90deg]">
                            <circle stroke="currentColor" fill="transparent" strokeWidth={stroke} strokeDasharray={circumference + ' ' + circumference} style={{ strokeDashoffset: circumference }} r={normalizedRadius} cx={radius} cy={radius} className="text-slate-200 dark:text-slate-700" />
                            <circle stroke={color} fill="transparent" strokeWidth={stroke} strokeDasharray={circumference + ' ' + circumference} style={{ strokeDashoffset, transition: 'stroke-dashoffset 1s ease-in-out' }} r={normalizedRadius} cx={radius} cy={radius} strokeLinecap="round" />
                        </svg>
                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                            {children}
                        </div>
                    </div>
                );
            };



            const handleViewChange = (newView) => {
                setView(newView);
            };





            return (
                <div className="min-h-screen pb-10 w-full overflow-x-hidden relative">
                    <Toast message={toast.message} visible={toast.visible} type={toast.type} />
                    <div className="aurora-bg"></div>

                    <NavBar
                        view={view}
                        setView={handleViewChange}
                        theme={theme}
                        setTheme={setTheme}
                        lastSync={lastSync}
                        onNewLog={() => {
                            setEntry({ title: "", logic: "", code: "", difficulty: "Medium", topic: "General", subtopic: "", date: new Date().toISOString().split('T')[0] });
                            setView("editing");
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }}
                    />

                    <main className="max-w-[1600px] mx-auto p-4 md:px-8 relative z-10">
                        {view === "practice" ? (
                            <div className="space-y-4 animate-fade-in">
                                <div className="flex flex-col md:flex-row gap-4 items-center justify-between glass p-4 rounded-2xl">
                                    <div className="flex flex-col md:flex-row gap-4 w-full md:w-3/4">
                                        <div className="flex-[2] relative">
                                            <input type="text" placeholder="Question Name" className="w-full p-3 bg-slate-100 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl outline-none font-bold text-lg dark:text-white placeholder:opacity-50" value={practiceEntry.title} onChange={e => setPracticeEntry({ ...practiceEntry, title: e.target.value })} />
                                        </div>
                                        <div className="flex-1 relative group/diff">
                                            <select
                                                value={practiceEntry.difficulty}
                                                onChange={e => setPracticeEntry({ ...practiceEntry, difficulty: e.target.value })}
                                                className={`w-full appearance-none p-3 border border-slate-200 dark:border-slate-700 rounded-xl outline-none font-bold cursor-pointer transition-colors ${practiceEntry.difficulty === 'Hard' ? 'bg-red-500/10 text-red-500' : practiceEntry.difficulty === 'Easy' ? 'bg-green-500/10 text-green-500' : 'bg-orange-500/10 text-orange-500'}`}
                                            >
                                                <option value="Easy">Easy</option>
                                                <option value="Medium">Medium</option>
                                                <option value="Hard">Hard</option>
                                            </select>
                                            <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none opacity-50 text-[10px]">‚ñº</div>
                                        </div>
                                        <input type="text" placeholder="Topic" className="flex-1 p-3 bg-slate-100 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl outline-none font-bold opacity-80 dark:text-white placeholder:opacity-50" value={practiceEntry.topic} onChange={e => setPracticeEntry({ ...practiceEntry, topic: e.target.value })} />
                                        <input type="text" placeholder="Subtopic" className="flex-1 p-3 bg-slate-100 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl outline-none font-bold opacity-80 dark:text-white placeholder:opacity-50" value={practiceEntry.subtopic} onChange={e => setPracticeEntry({ ...practiceEntry, subtopic: e.target.value })} />
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <div className="text-2xl font-mono font-black text-orange-500 bg-orange-500/10 px-4 py-2 rounded-xl">{formatTime(timer)}</div>
                                        <button onClick={() => setIsTimerRunning(!isTimerRunning)} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg">{isTimerRunning ? "‚è∏" : "‚ñ∂Ô∏è"}</button>
                                        <button onClick={() => setTimer(0)} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg">üîÑ</button>
                                    </div>
                                </div>
                                <div className="rounded-xl overflow-hidden border border-slate-300 dark:border-slate-700 shadow-2xl bg-[#1e1e1e] flex flex-col h-[600px]">
                                    <div className="flex bg-[#252526] text-white text-xs font-bold border-b border-black items-center justify-between pr-2">
                                        <div className="px-4 py-2 bg-[#1e1e1e] border-t-2 border-orange-500 flex items-center gap-2">
                                            <select
                                                value={practiceEntry.language}
                                                onChange={e => setPracticeEntry({ ...practiceEntry, language: e.target.value })}
                                                className="bg-transparent outline-none text-blue-400 cursor-pointer appearance-none uppercase font-bold"
                                            >
                                                <option value="cpp">C++</option>
                                                <option value="python">Python</option>
                                                <option value="javascript">JavaScript</option>
                                                <option value="java">Java</option>
                                                <option value="go">Go</option>
                                            </select>
                                        </div>
                                        <button
                                            onClick={runCode}
                                            disabled={isCompiling}
                                            className={`px-3 py-1 bg-green-600 hover:bg-green-500 text-white rounded flex items-center gap-1 transition-all ${isCompiling ? 'opacity-50 cursor-not-allowed' : ''}`}
                                        >
                                            {isCompiling ? 'Running...' : '‚ñ∂ Run'}
                                        </button>
                                    </div>
                                    <div className="flex-1 flex flex-col md:flex-row overflow-hidden relative">
                                        <div className="flex-1 relative group bg-[#1e1e1e]">
                                            <Editor
                                                language={practiceEntry.language}
                                                theme={theme}
                                                value={practiceEntry.code}
                                                onChange={(val) => setPracticeEntry(prev => ({ ...prev, code: val }))}
                                            />
                                        </div>
                                        <div className="w-[1px] bg-black"></div>
                                        <div className="flex-1 bg-[#1e1e1e] overflow-auto relative border-t md:border-t-0 md:border-l border-slate-700 flex flex-col">
                                            <div className="bg-[#252526] text-[10px] font-bold text-slate-400 px-4 py-1 uppercase tracking-widest border-b border-black">Output</div>
                                            <pre className="p-4 flex-1 text-xs font-mono text-white whitespace-pre-wrap overflow-auto">
                                                {output || <span className="opacity-30 italic">Click Run to see output...</span>}
                                            </pre>
                                        </div>
                                    </div>
                                </div>
                                <button onClick={() => handleAction({ ...data, practice: [{ ...practiceEntry, time: formatTime(timer), id: Date.now(), date: new Date().toLocaleDateString('en-GB') }, ...data.practice] }, "Add Practice")} className="w-full bg-slate-900 dark:bg-white text-white dark:text-black py-4 font-bold rounded-2xl shadow-xl hover:opacity-90 transition-all text-lg">Save & Finish</button>
                            </div>
                        ) : view === "theory" ? (
                            <div className="space-y-6 animate-fade-in dark:text-white">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-3xl font-black">Theory Notes</h2>
                                    <div className="flex items-center gap-4">
                                        <input
                                            type="text"
                                            placeholder="Search notes..."
                                            value={theorySearchTerm}
                                            onChange={(e) => setTheorySearchTerm(e.target.value)}
                                            className="hidden md:block bg-slate-100 dark:bg-slate-800 border-none outline-none rounded-xl px-4 py-2 font-bold text-sm min-w-[200px]"
                                        />
                                        <button onClick={() => { setTheoryEntry({ id: null, title: "", topic: "", date: new Date().toISOString().split('T')[0], content: "" }); setView("theory_edit"); }} className="bg-pink-600 hover:bg-pink-500 text-white px-6 py-2 rounded-xl font-bold shadow-lg transition-transform hover:scale-105">+ New Note</button>
                                    </div>
                                </div>

                                {/* Mobile Search */}
                                <input
                                    type="text"
                                    placeholder="Search notes..."
                                    value={theorySearchTerm}
                                    onChange={(e) => setTheorySearchTerm(e.target.value)}
                                    className="md:hidden w-full bg-slate-100 dark:bg-slate-800 border-none outline-none rounded-xl px-4 py-3 font-bold text-sm mb-4"
                                />

                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {data.theory
                                        .filter(t =>
                                            (t.title && t.title.toLowerCase().includes(theorySearchTerm.toLowerCase())) ||
                                            (t.topic && t.topic.toLowerCase().includes(theorySearchTerm.toLowerCase())) ||
                                            (t.content && t.content.toLowerCase().includes(theorySearchTerm.toLowerCase()))
                                        )
                                        .map(t => (
                                            <div key={t.id} onClick={() => { setTheoryEntry(t); setView("theory_read"); }} className="stat-card !min-h-0 p-6 relative group border-t-4 border-t-pink-500 hover:border-t-pink-400 cursor-pointer hover:scale-[1.02] transition-transform">
                                                <h3 className="text-xl font-extrabold mb-1 line-clamp-1">{t.title}</h3>
                                                <div className="text-xs font-bold opacity-50 uppercase tracking-widest mb-4">{t.topic} ‚Ä¢ {t.date}</div>
                                                <div className="line-clamp-4 opacity-70 text-sm markdown-body" dangerouslySetInnerHTML={{ __html: marked.parse(t.content) }}></div>
                                            </div>
                                        ))}
                                    {data.theory.length === 0 && (
                                        <div className="col-span-full text-center p-12 opacity-50 border-2 border-dashed border-slate-300 dark:border-slate-800 rounded-3xl">
                                            <div className="text-4xl mb-4">üìì</div>
                                            <p className="font-bold">No notes yet. Create one to get started!</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ) : view === "theory_read" ? (
                            <div className="space-y-6 animate-fade-in dark:text-white w-full min-h-screen">
                                <div className="flex justify-between items-center sticky top-0 bg-var(--bg) py-4 z-10 backdrop-blur-md bg-opacity-90">
                                    <button onClick={() => setView("theory")} className="text-sm font-bold opacity-50 hover:opacity-100 flex items-center gap-1">‚Üê Back to Notes</button>
                                    <div className="flex items-center gap-2">
                                        <button onClick={() => { setTheoryEntry(theoryEntry); setView("theory_edit"); }} className="bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-900 dark:text-white px-4 py-2 rounded-xl font-bold transition-colors flex items-center gap-2 text-sm">
                                            <span>‚úèÔ∏è</span> Edit
                                        </button>
                                        <button onClick={() => downloadPDF(theoryEntry)} className="bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-900 dark:text-white px-4 py-2 rounded-xl font-bold transition-colors flex items-center gap-2 text-sm">
                                            <span>‚¨áÔ∏è</span> PDF
                                        </button>
                                        <button onClick={() => { handleDelete(theoryEntry.id, 'theory'); setView("theory"); }} className="bg-red-50 dark:bg-red-900/10 hover:bg-red-100 dark:hover:bg-red-900/20 text-red-500 px-4 py-2 rounded-xl font-bold transition-colors flex items-center gap-2 text-sm">
                                            <span>üóë</span> Delete
                                        </button>
                                    </div>
                                </div>

                                <div className="stat-card !min-h-0 p-8 md:p-12 border-t-4 border-t-pink-500">
                                    <h1 className="text-3xl md:text-5xl font-black mb-4 text-slate-900 dark:text-white leading-tight">{theoryEntry.title}</h1>
                                    <div className="flex gap-4 mb-8 text-xs font-bold uppercase tracking-widest opacity-50 border-b border-slate-200 dark:border-slate-800 pb-8">
                                        <span>{theoryEntry.topic}</span>
                                        <span>‚Ä¢</span>
                                        <span>{theoryEntry.date}</span>
                                    </div>
                                    <div className="markdown-body text-lg" dangerouslySetInnerHTML={{ __html: marked.parse(theoryEntry.content || "") }}></div>
                                </div>
                            </div>
                        ) : view === "theory_edit" ? (
                            <div className="space-y-4 animate-fade-in dark:text-white h-[calc(100vh-140px)] flex flex-col">
                                <div className="flex justify-between items-center">
                                    <button onClick={() => setView(theoryEntry.id ? "theory_read" : "theory")} className="text-sm font-bold opacity-50 hover:opacity-100">‚Üê Back</button>
                                    <div className="flex items-center gap-2">
                                        <h2 className="text-xl font-black">{theoryEntry.id ? 'Edit Note' : 'New Note'}</h2>
                                        <button onClick={() => {
                                            const newEntry = { ...theoryEntry, id: theoryEntry.id || Date.now() };
                                            const newData = {
                                                ...data,
                                                theory: theoryEntry.id ? data.theory.map(t => t.id === theoryEntry.id ? newEntry : t) : [newEntry, ...data.theory]
                                            };
                                            handleAction(newData, `${theoryEntry.id ? 'Updated' : 'Created'} Theory Note: ${theoryEntry.title}`);
                                            setTheoryEntry(newEntry);
                                            // Return to read mode if editing, else stay or go to list
                                            if (theoryEntry.id) setView("theory_read");
                                            else setView("theory");
                                        }} className="bg-pink-600 hover:bg-pink-500 text-white px-6 py-2 rounded-xl font-bold shadow-lg transition-transform hover:scale-105 text-sm">
                                            Save Note
                                        </button>
                                    </div>
                                </div>
                                <div className="flex flex-col md:flex-row gap-4">
                                    <input type="text" placeholder="Note Title (e.g. OSI Model)" className="flex-[2] p-3 bg-white dark:bg-[#1e1e1e] border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-lg outline-none" value={theoryEntry.title} onChange={e => setTheoryEntry({ ...theoryEntry, title: e.target.value })} />
                                    <input type="text" placeholder="Topic" className="flex-1 p-3 bg-white dark:bg-[#1e1e1e] border border-slate-200 dark:border-slate-700 rounded-xl font-bold outline-none" value={theoryEntry.topic} onChange={e => setTheoryEntry({ ...theoryEntry, topic: e.target.value })} />
                                    <input type="date" className="p-3 bg-white dark:bg-[#1e1e1e] border border-slate-200 dark:border-slate-700 rounded-xl font-bold outline-none" value={theoryEntry.date} onChange={e => setTheoryEntry({ ...theoryEntry, date: e.target.value })} />
                                </div>

                                {/* Split Editor Layout */}
                                <div className="flex-1 flex flex-col border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden bg-[#1e1e1e]">
                                    {/* Top: Editor */}
                                    <div className="flex-1 border-b border-black relative">
                                        <div className="absolute top-0 right-0 z-10 bg-black/50 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg backdrop-blur-sm uppercase tracking-widest pointer-events-none">Markdown Source</div>
                                        <Editor
                                            language="markdown"
                                            theme={theme}
                                            value={theoryEntry.content}
                                            onChange={(val) => setTheoryEntry(prev => ({ ...prev, content: val }))}
                                        />
                                    </div>
                                    {/* Bottom: Preview */}
                                    <div className="flex-1 bg-white dark:bg-[#0d1117] overflow-auto flex flex-col relative">
                                        <div className="sticky top-0 right-0 z-10 bg-slate-100 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-4 py-1 text-xs font-bold uppercase tracking-widest opacity-70">Live Preview</div>
                                        <div
                                            className="p-8 markdown-body"
                                            dangerouslySetInnerHTML={{ __html: marked.parse(theoryEntry.content || "*Preview will appear here...*") }}
                                        ></div>
                                    </div>
                                </div>
                            </div>
                        ) : view === "practice_logs" ? (
                            <div className="space-y-6 animate-fade-in dark:text-white relative min-h-screen">
                                <h2 className="text-3xl font-black mb-6 text-center">Practice History</h2>

                                {/* Grouped Grid Layout */}
                                {Object.entries(data.practice.reduce((acc, p) => {
                                    const t = p.topic || "General";
                                    if (!acc[t]) acc[t] = [];
                                    acc[t].push(p);
                                    return acc;
                                }, {})).sort((a, b) => a[0].localeCompare(b[0])).map(([topic, items]) => (
                                    <div key={topic} className="space-y-4">
                                        <div className="flex items-center gap-4">
                                            <h3 className="text-2xl font-bold dark:text-white border-l-4 border-orange-500 pl-4">{topic}</h3>
                                            <div className="h-[1px] flex-1 bg-slate-200 dark:bg-slate-800"></div>
                                            <span className="text-xs font-bold opacity-50 bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded-full">{items.length}</span>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">

                                            {items.map(p => (
                                                <div
                                                    key={p.id}
                                                    onClick={() => setExpandedPracticeId(p.id)}
                                                    className="bg-white dark:bg-[#1e1e1e] p-8 rounded-2xl shadow-sm hover:shadow-xl cursor-pointer transform hover:-translate-y-1 transition-all duration-300 border border-slate-100 dark:border-slate-800 flex flex-col items-center justify-center text-center group h-48 relative overflow-hidden"
                                                >
                                                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-500"></div>

                                                    <div className="mb-4 opacity-50 group-hover:opacity-100 transition-opacity transform group-hover:scale-110 duration-300 text-4xl">
                                                        {p.language === 'python' ? 'üêç' : p.language === 'javascript' ? 'üìú' : p.language === 'go' ? 'üêπ' : p.language === 'java' ? '‚òï' : '‚ö°'}
                                                    </div>

                                                    <h3 className="text-lg font-black text-slate-800 dark:text-slate-100 line-clamp-2 px-2 leading-tight group-hover:text-transparent group-hover:bg-clip-text group-hover:bg-gradient-to-r group-hover:from-blue-600 group-hover:to-purple-600 transition-colors">
                                                        {p.title || "Untitled Question"}
                                                    </h3>

                                                    <div className="absolute bottom-4 text-[10px] font-bold uppercase tracking-widest text-slate-400 opacity-0 group-hover:opacity-100 transition-all transform translate-y-2 group-hover:translate-y-0">
                                                        Click to view details
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}

                                {data.practice.length === 0 && (
                                    <div className="text-center p-12 opacity-50 border-2 border-dashed border-slate-300 dark:border-slate-800 rounded-3xl">
                                        <div className="text-4xl mb-4">‚å®Ô∏è</div>
                                        <p className="font-bold">No practice sessions recorded yet.</p>
                                    </div>
                                )}

                                {/* Expanded Modal - Premium & Perfected */}
                                {expandedPracticeId && (
                                    <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-md animate-fade-in" onClick={() => setExpandedPracticeId(null)}>
                                        <div
                                            className="bg-white dark:bg-[#0d1117] w-full max-w-5xl max-h-[90vh] rounded-3xl shadow-2xl flex flex-col overflow-hidden animate-slide-up border border-slate-200 dark:border-slate-800 ring-1 ring-white/10"
                                            onClick={e => e.stopPropagation()}
                                        >
                                            {/* Modal Header */}
                                            <div className="p-6 md:p-8 border-b border-slate-100 dark:border-slate-800 flex flex-col md:flex-row justify-between items-start gap-6 md:gap-0 bg-slate-50/50 dark:bg-[#161b22]">
                                                <div className="w-full md:w-auto">
                                                    <h2 className="text-xl md:text-2xl font-black text-slate-900 dark:text-white mb-3 tracking-tight leading-snug">
                                                        {data.practice.find(p => p.id === expandedPracticeId)?.title || "Untitled Practice"}
                                                    </h2>
                                                    <div className="flex flex-wrap gap-3 items-center text-sm font-medium text-slate-500 dark:text-slate-400">
                                                        <span className="flex items-center gap-1 bg-slate-200 dark:bg-slate-800 px-2 py-1 rounded text-xs font-bold uppercase tracking-wider text-slate-700 dark:text-slate-300">
                                                            {data.practice.find(p => p.id === expandedPracticeId)?.language}
                                                        </span>
                                                        <span>‚Ä¢</span>
                                                        <span>{data.practice.find(p => p.id === expandedPracticeId)?.date}</span>
                                                        <span>‚Ä¢</span>
                                                        <span className="text-orange-500 font-bold">{data.practice.find(p => p.id === expandedPracticeId)?.time}</span>
                                                        {data.practice.find(p => p.id === expandedPracticeId)?.subtopic && (
                                                            <>
                                                                <span>‚Ä¢</span>
                                                                <span className="italic opacity-80">{data.practice.find(p => p.id === expandedPracticeId)?.subtopic}</span>
                                                            </>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="flex gap-2 w-full md:w-auto justify-end md:justify-start">
                                                    <button
                                                        onClick={() => {
                                                            const p = data.practice.find(p => p.id === expandedPracticeId);
                                                            navigator.clipboard.writeText(p.code);
                                                            showToast("Solution Copied to Clipboard!", "success");
                                                        }}
                                                        className="p-3 bg-blue-50 dark:bg-blue-900/10 hover:bg-blue-100 dark:hover:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-xl font-bold text-sm transition-colors flex items-center gap-2"
                                                    >
                                                        üìã Copy
                                                    </button>
                                                    <button
                                                        onClick={() => {
                                                            handleDelete(expandedPracticeId, 'practice');
                                                            setExpandedPracticeId(null);
                                                        }}
                                                        className="p-3 bg-red-50 dark:bg-red-900/10 hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 dark:text-red-400 rounded-xl font-bold text-sm transition-colors flex items-center gap-2"
                                                    >
                                                        üóë Delete
                                                    </button>
                                                    <button
                                                        onClick={() => setExpandedPracticeId(null)}
                                                        className="p-3 hover:bg-slate-200 dark:hover:bg-slate-800 rounded-xl text-slate-500 transition-colors"
                                                    >
                                                        <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Modal Content (Code) */}
                                            <div className="flex-1 overflow-auto bg-[#0d1117] relative group/code">
                                                <div className="absolute top-4 right-4 z-10 opacity-0 group-hover/code:opacity-100 transition-opacity">
                                                    <span className="text-[10px] font-bold uppercase tracking-widest text-[#8b949e] bg-[#0d1117] border border-[#30363d] px-2 py-1 rounded">Read Only</span>
                                                </div>
                                                <pre className="p-8 font-mono text-sm leading-relaxed text-[#e6edf3] whitespace-pre-wrap outline-none selection:bg-blue-500/30">
                                                    <code>{data.practice.find(p => p.id === expandedPracticeId)?.code}</code>
                                                </pre>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : view === "editing" ? (
                            <div className="space-y-6 animate-fade-in dark:text-white">
                                {/* Top Bar: Token & Metadata */}
                                <div className="stat-card !min-h-0 p-6 space-y-4">
                                    <h2 className="text-xl font-black mb-4">Create New Log</h2>
                                    <input type="password" placeholder="GitHub Token (Required to Save)" className="w-full p-4 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl outline-none transition-all focus:border-blue-500 text-slate-900 dark:text-white placeholder:text-slate-400" value={token} onChange={e => { setToken(e.target.value); localStorage.setItem('gh_token', e.target.value); }} />
                                    <div className="space-y-4">
                                        <div className="space-y-1">
                                            <label className="text-[10px] font-bold uppercase opacity-50 ml-1">Question Title</label>
                                            <input type="text" placeholder="e.g. Two Sum" className="w-full h-[52px] p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl font-bold text-lg text-slate-900 dark:text-white placeholder:text-slate-400" value={entry.title} onChange={e => setEntry({ ...entry, title: e.target.value })} />
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-bold uppercase opacity-50 ml-1">Date</label>
                                                <input type="date" className="w-full h-[52px] p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl font-bold text-slate-900 dark:text-white" value={entry.date} onChange={e => setEntry({ ...entry, date: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-bold uppercase opacity-50 ml-1">Topic</label>
                                                <input type="text" placeholder="e.g. Arrays" className="w-full h-[52px] p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl font-bold text-slate-900 dark:text-white placeholder:text-slate-400" value={entry.topic} onChange={e => setEntry({ ...entry, topic: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-bold uppercase opacity-50 ml-1">Subtopic</label>
                                                <input type="text" placeholder="e.g. Sliding Window + Two Pointer" className="w-full h-[52px] p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl font-bold text-slate-900 dark:text-white placeholder:text-slate-400" value={entry.subtopic} onChange={e => setEntry({ ...entry, subtopic: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-bold uppercase opacity-50 ml-1">Difficulty</label>
                                                <div className="relative">
                                                    <select className="w-full h-[52px] p-3 appearance-none bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl font-bold text-slate-900 dark:text-white" value={entry.difficulty} onChange={e => setEntry({ ...entry, difficulty: e.target.value })}><option>Easy</option><option>Medium</option><option>Hard</option></select>
                                                    <div className="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-slate-500">‚ñº</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Section 1: Logic (Markdown + Preview) */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 h-[500px]">
                                    <div className="stat-card !min-h-0 p-0 flex flex-col overflow-hidden border-2 border-transparent focus-within:border-blue-500 transition-colors">
                                        <div className="bg-slate-200 dark:bg-slate-700 px-4 py-2 border-b border-slate-300 dark:border-slate-600 font-black text-xs uppercase tracking-widest text-slate-700 dark:text-white">Logic (Markdown)</div>
                                        <textarea className="flex-1 p-4 bg-white dark:bg-slate-900 outline-none resize-none font-sans text-sm leading-relaxed text-slate-900 dark:text-white placeholder:text-slate-400" placeholder="Explain your approach here using Markdown..." value={entry.logic} onChange={e => setEntry({ ...entry, logic: e.target.value })}></textarea>
                                    </div>
                                    <div className="stat-card !min-h-0 p-0 flex flex-col overflow-hidden bg-slate-50 dark:bg-slate-900">
                                        <div className="bg-slate-200 dark:bg-slate-700 px-4 py-2 border-b border-slate-300 dark:border-slate-600 font-black text-xs uppercase tracking-widest text-slate-700 dark:text-white">Preview</div>
                                        <div
                                            className="flex-1 p-4 overflow-auto markdown-body"
                                            style={{ color: theme === 'dark' ? '#f1f5f9' : '#0f172a' }}
                                            dangerouslySetInnerHTML={{ __html: marked.parse(entry.logic || "*Preview will appear here*") }}
                                        ></div>
                                    </div>
                                </div>

                                {/* Section 2: Code (Distinct) */}
                                <div className="stat-card !min-h-0 p-0 overflow-hidden shadow-2xl border-t-4 border-blue-500">
                                    <div className="bg-[#1e1e1e] text-white px-4 py-2 border-b border-black flex items-center justify-between">
                                        <span className="text-xs font-bold uppercase tracking-widest">Solution Code</span>
                                        <span className="text-[10px] opacity-50">C++</span>
                                    </div>
                                    <textarea className="w-full h-[400px] bg-[#1e1e1e] text-[#d4d4d4] p-4 outline-none font-mono text-sm resize-none" spellCheck="false" placeholder="// Write your final solution code here..." value={entry.code} onChange={e => setEntry({ ...entry, code: e.target.value })}></textarea>
                                </div>

                                <button onClick={() => {
                                    // If ID exists, update. Else add new.
                                    // Robust Date Formatting (YYYY-MM-DD -> DD/MM/YYYY)
                                    let formattedDate = entry.date;
                                    if (entry.date && entry.date.includes('-')) {
                                        const [y, m, d] = entry.date.split('-');
                                        formattedDate = `${d}/${m}/${y}`;
                                    }

                                    // Create new log object
                                    const newLog = {
                                        ...entry,
                                        id: entry.id || Date.now(),
                                        date: formattedDate
                                    };

                                    let newLogs;
                                    if (entry.id) {
                                        newLogs = data.logs.map(l => l.id === entry.id ? newLog : l);
                                    } else {
                                        newLogs = [newLog, ...data.logs];
                                    }

                                    const newHistory = [...new Set([...data.history, formattedDate])];

                                    handleAction({ ...data, logs: newLogs, history: newHistory }, entry.id ? "Updated Log" : "Added New Log");
                                }} className="w-full bg-slate-900 dark:bg-white hover:opacity-90 text-white dark:text-black py-4 font-bold rounded-xl shadow-xl transition-all transform hover:scale-[1.01]">Push Log to GitHub</button>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                {/* Hero Section */}
                                <div className="mb-2">
                                    <h1 className="text-3xl md:text-4xl font-black text-slate-900 dark:text-white mb-2">{greeting}, {USER}! üëã</h1>
                                    <p className="text-slate-500 dark:text-slate-400 font-medium">Ready to crack some code today?</p>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <Calendar
                                        calendarData={calendarData}
                                        setSearchTerm={setSearchTerm}
                                        onPrev={() => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() - 1, 1))}
                                        onNext={() => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 1))}
                                    />
                                    <StatCard className="border-l-4 border-l-blue-600 flex items-center justify-center relative overflow-hidden">
                                        <div className="relative w-40 h-40 flex items-center justify-center">
                                            <svg className="w-full h-full rotate-[-90deg]" viewBox="0 0 100 100">
                                                <circle className="text-slate-100 dark:text-slate-800 stroke-current" strokeWidth="8" cx="50" cy="50" r="40" fill="transparent"></circle>
                                                <circle className="text-blue-500 progress-ring__circle stroke-current" strokeWidth="8" strokeLinecap="round" cx="50" cy="50" r="40" fill="transparent" strokeDasharray={`${2 * Math.PI * 40}`} strokeDashoffset={`${2 * Math.PI * 40 * (1 - (data.logs.length / 100))}`}></circle>
                                            </svg>
                                            <div className="absolute flex flex-col items-center">
                                                <h2 className="text-4xl font-black text-blue-500">{data.logs.length}</h2>
                                                <p className="text-[9px] font-bold opacity-40 uppercase tracking-widest dark:text-white">Solved</p>
                                            </div>
                                        </div>
                                        <div className="absolute right-4 bottom-4 text-xs font-bold text-slate-400">Goal: 100</div>
                                    </StatCard>
                                    <StatCard className="border-l-4 border-l-indigo-600 flex items-center justify-center relative overflow-hidden">
                                        <div className="relative w-40 h-40 flex items-center justify-center">
                                            <svg className="w-full h-full rotate-[-90deg]" viewBox="0 0 100 100">
                                                <circle className="text-slate-100 dark:text-slate-800 stroke-current" strokeWidth="8" cx="50" cy="50" r="40" fill="transparent"></circle>
                                                <circle className="text-indigo-500 progress-ring__circle stroke-current" strokeWidth="8" strokeLinecap="round" cx="50" cy="50" r="40" fill="transparent" strokeDasharray={`${2 * Math.PI * 40}`} strokeDashoffset={`${2 * Math.PI * 40 * (1 - (data.history.length / 100))}`}></circle>
                                            </svg>
                                            <div className="absolute flex flex-col items-center">
                                                <h2 className="text-4xl font-black text-indigo-500">{data.history.length}</h2>
                                                <p className="text-[9px] font-bold opacity-40 uppercase tracking-widest dark:text-white">Days Worked</p>
                                            </div>
                                        </div>
                                        <div className="absolute right-4 bottom-4 text-xs font-bold text-slate-400">Goal: 100</div>
                                    </StatCard>
                                    <StatCard className="border-l-4 border-l-orange-500 flex items-center justify-center relative overflow-hidden">
                                        <div className="relative w-40 h-40 flex items-center justify-center">
                                            <svg className="w-full h-full rotate-[-90deg]" viewBox="0 0 100 100">
                                                <circle className="text-slate-100 dark:text-slate-800 stroke-current" strokeWidth="8" cx="50" cy="50" r="40" fill="transparent"></circle>
                                                <circle className="text-orange-500 progress-ring__circle stroke-current" strokeWidth="8" strokeLinecap="round" cx="50" cy="50" r="40" fill="transparent" strokeDasharray={`${2 * Math.PI * 40}`} strokeDashoffset={`${2 * Math.PI * 40 * (1 - (data.practice.length / 50))}`}></circle>
                                            </svg>
                                            <div className="absolute flex flex-col items-center">
                                                <h2 className="text-4xl font-black text-orange-500">{data.practice.length}</h2>
                                                <p className="text-[9px] font-bold opacity-40 uppercase tracking-widest dark:text-white">Sessions</p>
                                            </div>
                                        </div>
                                        <div className="absolute right-4 bottom-4 text-xs font-bold text-slate-400">Goal: 150</div>
                                    </StatCard>
                                </div>
                                <div className="mt-8">
                                    <ContributionHeatmap data={data} />
                                </div>

                                {/* Topic Distribution Chart */}
                                {topicStats.length > 0 && (
                                    <div className="stat-card !min-h-0 p-6 space-y-4">
                                        <div className="flex justify-between items-center">
                                            <h3 className="text-xs font-black uppercase tracking-widest opacity-50 dark:text-white">
                                                {groupBy === 'topic' ? 'Topic Distribution' : 'Subtopic Distribution'}
                                            </h3>
                                            <div className="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                                                <button onClick={() => setGroupBy('topic')} className={`px-2 py-1 rounded text-[10px] font-bold transition-all ${groupBy === 'topic' ? 'bg-white dark:bg-slate-700 shadow text-indigo-500' : 'opacity-50'}`}>Topic</button>
                                                <button onClick={() => setGroupBy('subtopic')} className={`px-2 py-1 rounded text-[10px] font-bold transition-all ${groupBy === 'subtopic' ? 'bg-white dark:bg-slate-700 shadow text-indigo-500' : 'opacity-50'}`}>Subtopic</button>
                                            </div>
                                        </div>
                                        <div className="flex h-4 rounded-full overflow-hidden w-full bg-slate-100 dark:bg-slate-800">
                                            {topicStats.map((t, i) => (
                                                <div key={t.name} style={{ width: `${t.percent}%`, backgroundColor: `hsl(${220 + (i * 40)}, 70%, 50%)` }} title={`${t.name}: ${t.count}`} />
                                            ))}
                                        </div>
                                        <div className="flex flex-wrap gap-3">
                                            {topicStats.slice(0, 5).map((t, i) => (
                                                <div key={t.name} className="flex items-center gap-1.5 text-[10px] font-bold dark:text-white">
                                                    <div className="w-2 h-2 rounded-full" style={{ backgroundColor: `hsl(${220 + (i * 40)}, 70%, 50%)` }}></div>
                                                    {t.name} <span className="opacity-50">({Math.round(t.percent)}%)</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Study Topics (Notes) Grid */}
                                {noteTopics.length > 0 && (
                                    <div className="space-y-4">
                                        <h3 className="text-lg font-extrabold dark:text-white text-pink-500">Study Topics</h3>
                                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                                            {noteTopics.map((t) => (
                                                <button
                                                    key={t.name}
                                                    onClick={() => { setTheorySearchTerm(t.name); setView('theory'); window.scrollTo({ top: 0, behavior: 'smooth' }); }}
                                                    className="p-4 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 hover:border-pink-500 dark:hover:border-pink-500 transition-all text-left group"
                                                >
                                                    <div className="text-[10px] font-bold opacity-40 uppercase mb-1 dark:text-white group-hover:text-pink-500">Note Topic</div>
                                                    <div className="font-bold text-sm truncate dark:text-white mb-2">{t.name}</div>
                                                    <div className="inline-block bg-slate-100 dark:bg-slate-800 text-xs font-bold px-2 py-1 rounded-lg dark:text-white group-hover:bg-pink-50 dark:group-hover:bg-pink-900/30 group-hover:text-pink-600 transition-colors">
                                                        {t.count} Notes
                                                    </div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Topic Explorer Grid (Logs) */}
                                {topicStats.length > 0 && (
                                    <div className="space-y-4">
                                        <h3 className="text-lg font-extrabold dark:text-white">
                                            {groupBy === 'topic' ? 'Explore Topics' : 'Explore Subtopics'}
                                        </h3>
                                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                                            {topicStats.map((t) => (
                                                <button
                                                    key={t.name}
                                                    onClick={() => { setSearchTerm(t.name); setPage(1); window.scrollTo({ top: 500, behavior: 'smooth' }); }}
                                                    className="p-4 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 hover:border-blue-500 dark:hover:border-blue-500 transition-all text-left group"
                                                >
                                                    <div className="text-[10px] font-bold opacity-40 uppercase mb-1 dark:text-white group-hover:text-blue-500">
                                                        {groupBy === 'topic' ? 'Topic' : 'Subtopic'}
                                                    </div>
                                                    <div className="font-bold text-sm truncate dark:text-white mb-2">{t.name}</div>
                                                    <div className="inline-block text-xs font-bold px-2 py-1 rounded-lg transition-colors border border-black/5 dark:border-white/5"
                                                        style={{
                                                            backgroundColor: groupBy === 'subtopic' ? (theme === 'dark' ? stringToColorDark(t.name) : stringToColor(t.name)) : (theme === 'dark' ? 'rgba(30, 41, 59, 1)' : 'rgba(241, 245, 249, 1)'),
                                                            color: groupBy === 'subtopic' ? (theme === 'dark' ? stringToColorTextDark(t.name) : stringToColorText(t.name)) : 'inherit'
                                                        }}
                                                    >
                                                        {t.count} Qs
                                                    </div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                <input type="text" placeholder="Search logs..." className="search-input text-slate-900 dark:text-white" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                <div className="flex gap-2 flex-wrap items-center">
                                    {['Easy', 'Medium', 'Hard'].map(diff => (
                                        <div
                                            key={diff}
                                            onClick={() => setDiffFilter(p => ({ ...p, [diff]: !p[diff] }))}
                                            className={`filter-chip chip-${diff.toLowerCase()} ${diffFilter[diff] ? 'active' : 'opacity-40'} flex items-center gap-2`}
                                        >
                                            {diff} <span className="bg-white/20 px-1.5 py-0.5 rounded-full text-[9px]">{diffCounts[diff]}</span>
                                        </div>
                                    ))}
                                    <button
                                        onClick={() => { setSearchTerm(""); setDiffFilter({ Easy: true, Medium: true, Hard: true }); setSortBy("Newest"); }}
                                        className="ml-auto px-4 h-10 rounded-xl font-bold text-xs bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 text-slate-700 dark:text-slate-300 hover:border-blue-500 hover:text-blue-600 transition-all flex items-center gap-2 group box-border shrink-0"
                                    >
                                        <span className="text-lg group-hover:rotate-180 transition-transform">‚Ü∫</span> Reset
                                    </button>
                                    <div className="h-6 w-[1px] bg-slate-200 dark:bg-slate-700 mx-2"></div>
                                    <div className="relative shrink-0">
                                        <select
                                            value={sortBy}
                                            onChange={(e) => setSortBy(e.target.value)}
                                            className="appearance-none pl-4 pr-10 h-10 rounded-xl font-bold text-xs bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 outline-none text-slate-700 dark:text-slate-300 hover:border-indigo-500 cursor-pointer transition-colors box-border"
                                        >
                                            <option value="Newest">Newest First</option>
                                            <option value="Oldest">Oldest First</option>
                                            <option value="Difficulty">Difficulty</option>
                                            <option value="Topic">Topic (A-Z)</option>
                                        </select>
                                        <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                                            <svg className="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" /></svg>
                                        </div>
                                    </div>
                                </div>
                                <div className="space-y-8">
                                    {Object.entries(groupedLogs).map(([topic, logs]) => (
                                        <div key={topic} className="space-y-4 animate-fade-in">
                                            <h3 className="font-extrabold text-lg flex items-center gap-2 dark:text-white before:content-['#'] before:text-blue-600 before:mr-1">{topic} <span className="text-xs opacity-40 bg-slate-200 dark:bg-slate-800 px-2 py-1 rounded-full">{logs.length}</span></h3>
                                            <div className="grid gap-4">
                                                {logs.map(log => (
                                                    <LogEntry
                                                        key={log.id}
                                                        log={log}
                                                        diffColors={diffColors}
                                                        expanded={expandedQuestion === log.id}
                                                        onToggle={() => setExpandedQuestion(expandedQuestion === log.id ? null : log.id)}
                                                        onDelete={(id) => handleDelete(id, log.type)}
                                                        onEdit={(l) => {
                                                            let validDate = l.date;
                                                            // Auto-repair Invalid Date -> Today
                                                            if (!l.date || l.date === "Invalid Date") {
                                                                validDate = new Date().toISOString().split('T')[0];
                                                            }
                                                            // Convert DD/MM/YYYY -> YYYY-MM-DD for input[type="date"]
                                                            else if (l.date.includes('/')) {
                                                                const [d, m, y] = l.date.split('/');
                                                                validDate = `${y}-${m}-${d}`;
                                                            }
                                                            setEntry({ ...l, date: validDate });
                                                            setView('editing');
                                                            window.scrollTo({ top: 0, behavior: 'smooth' });
                                                        }}
                                                        onDownload={(l) => downloadPDF(l)}
                                                    />
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                    {Object.keys(groupedLogs).length === 0 && (
                                        <div className="flex flex-col items-center justify-center py-20 text-center opacity-50 dark:text-white space-y-4">
                                            <div className="w-24 h-24 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center text-4xl">
                                                üîç
                                            </div>
                                            <div>
                                                <h3 className="text-xl font-bold">No logs found</h3>
                                                <p className="text-sm opacity-60">Try adjusting your search or filters</p>
                                            </div>
                                        </div>
                                    )}
                                    {filteredLogs.length > logsToDisplay.length && (
                                        <div className="flex justify-center pt-8">
                                            <button
                                                onClick={() => setPage(p => p + 1)}
                                                className="px-6 py-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors dark:text-white"
                                            >
                                                Load More ({filteredLogs.length - logsToDisplay.length} remaining)
                                            </button>
                                        </div>
                                    )}
                                </div>
                                <button
                                    onClick={() => setView('editing')}
                                    className="fixed bottom-8 right-8 w-14 h-14 bg-slate-900 dark:bg-white text-white dark:text-black rounded-full shadow-2xl flex items-center justify-center text-3xl font-light transform hover:scale-110 transition-all z-50"
                                    title="Quick Log"
                                >
                                    +
                                </button>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>

</html>
